<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Gimnasio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Focus -->
    <!-- Application Structure Plan: Se ha redise√±ado la UI seg√∫n las especificaciones del usuario, cambiando etiquetas y reorganizando el formulario para una entrada de datos m√°s compacta. Se ha a√±adido un modo oscuro autom√°tico basado en la hora de Argentina (GMT-3) para mejorar la usabilidad nocturna. -->
    <!-- Visualization & Content Choices: La funcionalidad de eliminar se mantiene. El cambio principal es est√©tico y de usabilidad, con una nueva lista de ejercicios y una nueva disposici√≥n de los controles de entrada. El modo oscuro se implementa con clases de Tailwind CSS y una funci√≥n JS que comprueba la hora. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .tab-button.active { border-color: #3b82f6; color: #2563eb; }
        .dark .tab-button.active { border-color: #60a5fa; color: #93c5fd; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 40vh; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .gemini-response { white-space: pre-wrap; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #global-loader, #confirmation-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-200">

    <div id="global-loader">
        <div class="loader" style="width: 50px; height: 50px; border-top-color: #fff;"></div>
        <p class="text-white mt-4">Conectando con la nube...</p>
    </div>

    <div id="app-content" class="container mx-auto p-4 md:p-6 max-w-4xl hidden">
        <nav class="flex justify-center border-b border-gray-200 dark:border-gray-700 mb-6 flex-wrap">
            <button data-tab="registrar" class="tab-button active text-lg font-semibold py-3 px-6 border-b-2 border-transparent transition-colors duration-300">Home</button>
            <button data-tab="historial" class="tab-button text-lg font-semibold py-3 px-6 border-b-2 border-transparent transition-colors duration-300">Log</button>
            <button data-tab="progreso" class="tab-button text-lg font-semibold py-3 px-6 border-b-2 border-transparent transition-colors duration-300">Viz</button>
            <button data-tab="analisis-ia" class="tab-button text-lg font-semibold py-3 px-6 border-b-2 border-transparent transition-colors duration-300">AI</button>
        </nav>

        <main>
            <!-- Home Tab -->
            <div id="registrar" class="tab-content space-y-6">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Training Next</h2>
                    <select id="exercise-select-main" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-3">Log</h3>
                        <div id="last-workout-display" class="text-gray-600 dark:text-gray-400 space-y-2">
                            <p>Empty</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                         <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-3">New Log</h3>
                        <form id="log-form" class="space-y-4">
                            <input type="date" id="date" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500">
                            <div class="flex items-center gap-4">
                                <label for="weight" class="block text-sm font-medium w-8">W</label>
                                <input type="number" id="weight" step="0.5" min="0" required class="flex-1 w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center gap-4">
                                <label for="series" class="block text-sm font-medium w-8">S</label>
                                <input type="number" id="series" min="1" required class="flex-1 w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center gap-4">
                                <label for="reps" class="block text-sm font-medium w-8">R</label>
                                <input type="number" id="reps" min="1" required class="flex-1 w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save</button>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Historial Tab -->
            <div id="historial" class="tab-content hidden"><div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">üìã Log</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ejercicio</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Peso</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Series</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Reps</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Volumen</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Acciones</th></tr></thead><tbody id="history-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody></table></div></div></div>
            <!-- Progreso Tab -->
            <div id="progreso" class="tab-content hidden"><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">üìä Viz</h2><p class="text-gray-600 dark:text-gray-400 mb-4">Selecciona un ejercicio para ver la evoluci√≥n de tu volumen de carga a lo largo del tiempo.</p><select id="exercise-select-chart" class="w-full md:w-1/2 p-3 mb-6 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"></select><div class="chart-container"><canvas id="progressChart"></canvas></div></div></div>
            <!-- Analisis IA Tab -->
            <div id="analisis-ia" class="tab-content hidden space-y-6"><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">üß† AI Analysis</h2><p class="text-gray-600 dark:text-gray-400 mb-4">Obt√©n un resumen de tu rendimiento y recomendaciones personalizadas.</p><button id="analyze-progress-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300">Analizar Mi Progreso</button><div id="progress-analysis-loader" class="hidden mt-4 flex justify-center"><div class="loader"></div></div><div id="progress-analysis-result" class="mt-4 p-4 bg-blue-50 dark:bg-gray-700 border border-blue-200 dark:border-blue-800 rounded-lg"></div></div><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">üí° AI Tips</h2><p class="text-gray-600 dark:text-gray-400 mb-4">Selecciona un ejercicio para recibir consejos sobre la forma y t√©cnica correctas.</p><div class="flex flex-col md:flex-row md:items-center gap-4"><select id="exercise-select-tips" class="w-full md:w-1/2 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"></select><button id="get-tips-btn" class="bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300">Obtener Consejos</button></div><div id="tips-loader" class="hidden mt-4 flex justify-center"><div class="loader"></div></div><div id="tips-result" class="mt-4 p-4 bg-purple-50 dark:bg-gray-700 border border-purple-200 dark:border-purple-800 rounded-lg"></div></div></div>
        </main>
        
        <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-500"></div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl text-center">
            <h3 class="text-xl font-bold mb-4">¬øEst√°s seguro?</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="py-2 px-6 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirm-delete-btn" class="py-2 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PEGA TU CONFIGURACI√ìN DE FIREBASE AQU√ç ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvxzKwwSulWGisEeAz-GeJUDEgAa_Ef1A",
            authDomain: "gymlog-570b5.firebaseapp.com",
            projectId: "gymlog-570b5",
            storageBucket: "gymlog-570b5.appspot.com",
            messagingSenderId: "318896567360",
            appId: "1:318896567360:web:7ceee667c0eb238c525ba5"
        };
        // -----------------------------------------

        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Error al inicializar Firebase. ¬øEst√°n las credenciales en su lugar?", e);
            document.getElementById('global-loader').innerHTML = `<div class="text-center p-4"><p class="text-red-500 font-bold text-lg">Error de Configuraci√≥n de Firebase</p><p class="text-white mt-2">No se pudo inicializar la aplicaci√≥n. Revisa que el objeto 'firebaseConfig' sea correcto.</p></div>`;
        }
        
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            const exercises = [
                "Arnold Press", "Back Raise", "Bicep Concentration Curl", "Bicep Curl", 
                "Crossed Lunge", "Deadlift", "Diamond Push Up", "Front Raise", "Hamstring Raise",
                "Lateral Raise", "Lunge", "Push Up", "Pyke Push Up", "Shrug", "Squat", 
                "Tricep Curl", "Tricep Kickback"
            ].sort();

            let database = [];
            let userId = null;
            let docIdToDelete = null;

            const mainSelect = document.getElementById('exercise-select-main');
            const chartSelect = document.getElementById('exercise-select-chart');
            const tipsSelect = document.getElementById('exercise-select-tips');
            const lastWorkoutDisplay = document.getElementById('last-workout-display');
            const logForm = document.getElementById('log-form');
            const historyTableBody = document.getElementById('history-table-body');
            const dateInput = document.getElementById('date');
            const toast = document.getElementById('toast');
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const analyzeProgressBtn = document.getElementById('analyze-progress-btn');
            const progressAnalysisResult = document.getElementById('progress-analysis-result');
            const progressLoader = document.getElementById('progress-analysis-loader');
            const getTipsBtn = document.getElementById('get-tips-btn');
            const tipsResult = document.getElementById('tips-result');
            const tipsLoader = document.getElementById('tips-loader');
            const globalLoader = document.getElementById('global-loader');
            const appContent = document.getElementById('app-content');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            let progressChart;
            
            function applyTheme() {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const utc = now.getTime();
                const artTime = new Date(utc - (3600000 * 3)); // UTC-3 for Argentina
                const hour = artTime.getHours();

                if (hour >= 19 || hour < 6) {
                    document.body.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                }
            }

            async function callGemini(prompt) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else { return "No se pudo obtener una respuesta de la IA."; }
                } catch (error) {
                    console.error("Error al llamar a la API de Gemini:", error);
                    return `Error al conectar con la IA: ${error.message}.`;
                }
            }

            async function init() {
                applyTheme();
                
                if (firebaseConfig.apiKey === "PEGA_TU_API_KEY_AQUI" || !firebaseConfig.apiKey) {
                    globalLoader.innerHTML = `<div class="text-center p-4 max-w-md"><p class="text-red-500 font-bold text-lg">Error de Configuraci√≥n</p><p class="text-white mt-2">No has configurado tus credenciales de Firebase.</p><p class="text-white mt-2">Por favor, edita el archivo <strong>index.html</strong> y reemplaza los valores de 'firebaseConfig' con los de tu propio proyecto de Firebase.</p></div>`;
                    return;
                }

                try {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                    setupRealtimeListener();
                    populateSelects();
                    setupChart();
                    dateInput.valueAsDate = new Date();
                    progressAnalysisResult.innerHTML = "Haz clic en el bot√≥n para generar un an√°lisis.";
                    tipsResult.innerHTML = "Selecciona un ejercicio y haz clic para obtener consejos.";
                } catch (error) {
                    console.error("Error en la inicializaci√≥n o autenticaci√≥n:", error);
                    if (error.code === 'auth/invalid-api-key' || (error.message && error.message.includes('API key not valid'))) {
                         globalLoader.innerHTML = `<div class="text-center p-4 max-w-md"><p class="text-red-500 font-bold text-lg">Clave de API no v√°lida</p><p class="text-white mt-2">La clave de API en tu configuraci√≥n de Firebase no es correcta.</p><p class="text-white mt-2">Aseg√∫rate de haber copiado y pegado el objeto <strong>firebaseConfig</strong> completo y sin errores desde la configuraci√≥n de tu proyecto de Firebase.</p></div>`;
                    } else {
                        globalLoader.innerHTML = `<p class="text-red-500">No se pudo conectar a la nube. Por favor, recarga la p√°gina.</p>`;
                    }
                }
            }

            function setupRealtimeListener() {
                const workoutsCollectionPath = `users/${userId}/workouts`;
                onSnapshot(collection(db, workoutsCollectionPath), (snapshot) => {
                    database = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAllUI();
                    if (globalLoader.style.display !== 'none') {
                        globalLoader.style.display = 'none';
                        appContent.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("Error al escuchar cambios en la base de datos:", error);
                     globalLoader.innerHTML = `<p class="text-red-500">Error de base de datos. Revisa las reglas de seguridad en tu proyecto de Firebase.</p>`;
                });
            }
            
            function updateAllUI() {
                updateHistoryTable();
                updateLastWorkoutDisplay();
                updateProgressChart();
            }

            function populateSelects() {
                const selects = [mainSelect, chartSelect, tipsSelect];
                selects.forEach(s => s.innerHTML = '<option value="" disabled selected>Elige un ejercicio...</option>');
                exercises.forEach(ex => {
                    selects.forEach(s => s.add(new Option(ex, ex)));
                });
            }

            function updateLastWorkoutDisplay() {
                const selectedExercise = mainSelect.value;
                if (!selectedExercise) {
                    lastWorkoutDisplay.innerHTML = '<p>Empty</p>';
                    return;
                }
                const lastWorkout = database.filter(e => e.exercise === selectedExercise).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                if (lastWorkout) {
                    lastWorkoutDisplay.innerHTML = `<p><strong>Fecha:</strong> ${new Date(lastWorkout.date).toLocaleDateString('es-ES',{timeZone:'UTC'})}</p><p><strong>W:</strong> ${lastWorkout.weight} kg</p><p><strong>S:</strong> ${lastWorkout.series}</p><p><strong>R:</strong> ${lastWorkout.reps}</p><p class="font-bold text-blue-600 dark:text-blue-400"><strong>Volumen:</strong> ${lastWorkout.volume} kg</p>`;
                } else {
                    lastWorkoutDisplay.innerHTML = '<p>Empty</p>';
                }
            }

            function updateHistoryTable() {
                historyTableBody.innerHTML = '';
                const sortedDb = [...database].sort((a,b) => new Date(b.date) - new Date(a.date));
                if (sortedDb.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">A√∫n no has registrado ning√∫n entrenamiento.</td></tr>';
                    return;
                }
                sortedDb.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(entry.date).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${entry.exercise}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${entry.weight} kg</td>
                        <td class="px-6 py-4 whitespace-nowrap">${entry.series}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${entry.reps}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold">${entry.volume}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="delete-btn text-red-600 hover:text-red-800" data-id="${entry.id}">üóëÔ∏è</button>
                        </td>
                    `;
                    historyTableBody.appendChild(row);
                });
            }
            
            function showToast(message) {
                toast.textContent = message;
                toast.classList.remove('opacity-0');
                setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
            }

            logForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const exercise = mainSelect.value;
                if (!exercise) { alert('Por favor, selecciona un ejercicio.'); return; }
                const weight = parseFloat(document.getElementById('weight').value);
                const series = parseInt(document.getElementById('series').value);
                const reps = parseInt(document.getElementById('reps').value);
                const date = dateInput.value;
                const newEntry = { date, exercise, weight, series, reps, volume: weight * series * reps };
                
                try {
                    const workoutsCollectionPath = `users/${userId}/workouts`;
                    await addDoc(collection(db, workoutsCollectionPath), newEntry);
                    showToast("Entrenamiento guardado!");
                    logForm.reset();
                    dateInput.valueAsDate = new Date();
                } catch (error) {
                    console.error("Error al guardar el entrenamiento: ", error);
                    alert("No se pudo guardar el entrenamiento en la nube. Revisa tu conexi√≥n.");
                }
            });

            historyTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    docIdToDelete = e.target.dataset.id;
                    confirmationModal.classList.remove('hidden');
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                docIdToDelete = null;
                confirmationModal.classList.add('hidden');
            });

            confirmDeleteBtn.addEventListener('click', async () => {
                if (docIdToDelete) {
                    try {
                        const docPath = `users/${userId}/workouts/${docIdToDelete}`;
                        await deleteDoc(doc(db, docPath));
                        showToast("Registro eliminado.");
                    } catch (error) {
                        console.error("Error al eliminar el documento: ", error);
                        alert("No se pudo eliminar el registro.");
                    } finally {
                        docIdToDelete = null;
                        confirmationModal.classList.add('hidden');
                    }
                }
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');
                    const target = tab.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.id === target ? content.classList.remove('hidden') : content.classList.add('hidden');
                    });
                });
            });

            mainSelect.addEventListener('change', updateLastWorkoutDisplay);
            chartSelect.addEventListener('change', updateProgressChart);

            analyzeProgressBtn.addEventListener('click', async () => {
                progressLoader.classList.remove('hidden');
                progressAnalysisResult.innerHTML = '';
                const recentData = database.slice(-30).map(e => `Fecha: ${e.date}, Ejercicio: ${e.exercise}, Peso: ${e.weight}kg, Series: ${e.series}, Reps: ${e.reps}, Volumen: ${e.volume}kg`).join('\n');
                const prompt = `Act√∫a como un entrenador personal experto y motivador. Analiza los siguientes datos de entrenamiento de un usuario. Proporciona un resumen conciso de su progreso, destaca 1-2 puntos fuertes y 1-2 √°reas de mejora. Finaliza con una recomendaci√≥n clara y accionable para su pr√≥xima semana. S√© positivo y directo. Formato: P√°rrafos cortos. Datos:\n${recentData}`;
                const result = await callGemini(prompt);
                progressAnalysisResult.innerHTML = result;
                progressLoader.classList.add('hidden');
            });

            getTipsBtn.addEventListener('click', async () => {
                const selectedExercise = tipsSelect.value;
                if (!selectedExercise) { tipsResult.innerHTML = "Por favor, selecciona un ejercicio primero."; return; }
                tipsLoader.classList.remove('hidden');
                tipsResult.innerHTML = '';
                const prompt = `Act√∫a como un experto en fisioculturismo y entrenador personal. Proporciona 3 consejos clave, concisos y pr√°cticos sobre la t√©cnica correcta y segura para realizar el ejercicio: "${selectedExercise}". Enf√≥cate en los errores m√°s comunes y c√≥mo evitarlos. La respuesta debe estar en espa√±ol y formateada como una lista HTML no ordenada (<ul><li>...</li></ul>).`;
                const result = await callGemini(prompt);
                tipsResult.innerHTML = result;
                tipsLoader.classList.add('hidden');
            });

            function setupChart() {
                const isDark = document.body.classList.contains('dark');
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDark ? '#e5e7eb' : '#374151';

                const ctx = document.getElementById('progressChart').getContext('2d');
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Volumen de Carga (kg)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', borderWidth: 2, tension: 0.1, fill: true }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                grid: { color: gridColor },
                                ticks: { color: textColor }
                            },
                            x: {
                                grid: { color: gridColor },
                                ticks: { color: textColor }
                            }
                        }, 
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                callbacks: { 
                                    label: function(context) { return `Volumen: ${context.parsed.y} kg`; } 
                                } 
                            } 
                        } 
                    }
                });
            }

            function updateProgressChart() {
                const selectedExercise = chartSelect.value;
                if (!progressChart) return;
                if (!selectedExercise) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets[0].data = [];
                    progressChart.update();
                    return;
                }
                const exerciseData = database.filter(e => e.exercise === selectedExercise).sort((a,b) => new Date(a.date) - new Date(b.date));
                progressChart.data.labels = exerciseData.map(e => new Date(e.date).toLocaleDateString('es-ES',{timeZone:'UTC'}));
                progressChart.data.datasets[0].data = exerciseData.map(e => e.volume);
                progressChart.data.datasets[0].label = `Volumen de Carga (${selectedExercise})`;
                progressChart.update();
            }

            init();
        });
    </script>
</body>
</html>
